# マイページ情報表示・編集インターフェース設計

## 1. 概要

マイページは**情報閲覧重視型**とし、ユーザーが自分のプロフィール情報を視覚的に確認できることを最優先する。公開プロフィール（`/p/{profile_id}`）と同じビジュアルで表示することで、「他の人からどう見えるか」を直感的に理解できるようにする。

編集は**一括編集モード方式**を採用し、「表示モード」と「編集モード」を明確に分離する。ページ右上の「編集」ボタンで編集モードに切り替え、すべての項目を一度に編集してから保存する。プレビュー機能は実装せず、保存後すぐに表示モードに反映されるシンプルな体験を提供する。

実装の前にTodoリスト(`docs/todo.md`)を参照してください。実装順序は 10.1 → 10.5 → 10.2 → 10.3 → 10.4 → 10.6 が自然な流れです（Server Actionを先に作り、次にUI、最後に検証）。

---

## 2. UI構造

### 2.1 表示モード

公開プロフィールと同じレイアウトを採用し、違和感のないビジュアルにする。

- **中央にプロフィールカード**：
  - アバター画像（120x120、中央配置）
  - 表示名（大きなタイトル）
  - 自己紹介（設定されていれば表示）
  - X リンクボタン（x_username が設定されていれば表示）

- **ページ右上に「編集」ボタン**：
  - コンパクトな配置で公開プロフィールの見た目を崩さない
  - クリックで編集モードに切り替え

- **その他の要素**：
  - OAuth連携状態を表示するカード
  - 「公開プロフィールを見る」リンク
  - ログアウトボタン

### 2.2 編集モード

シンプルな縦並びフォームで、すべての編集項目を一覧表示する。

- **アバター表示**（編集不可）：
  - 中央または上部に表示
  - 下部に小さく「※アバター変更は今後対応予定」とグレーのテキスト

- **フォーム項目**（上から順に）：
  1. 表示名（display_name）
  2. 自己紹介（bio）
  3. X アカウント（x_username）
  4. カスタムURL（slug）

- **下部に操作ボタン**：
  - 「保存する」ボタン（青色、目立つ）
  - 「キャンセル」ボタン（グレー、控えめ）

---

## 3. 編集項目仕様

### 3.1 表示名（display_name）
- **必須項目**
- 最大50文字
- 通常のテキスト入力フィールド
- バリデーション：空欄不可

### 3.2 自己紹介（bio）
- **任意項目**
- 最大160文字
- 複数行テキストエリア（3行程度）
- 文字カウンター表示：「0 / 160」形式
- プレースホルダー：「自己紹介を入力してください（160文字以内）」

### 3.3 X アカウント（x_username）
- **任意項目**（今回新規追加）
- **柔軟な入力形式を受け付け、自動正規化**：
  - `username` → そのまま保存
  - `@username` → `username` に正規化（@を削除）
  - `https://x.com/username` → `username` のみ抽出
  - `https://twitter.com/username` → `username` のみ抽出
- プレースホルダー：「username または https://x.com/username」
- 保存形式：`username`（@なし、URLなし）

### 3.4 カスタムURL（slug）
- **任意項目**
- 3〜20文字
- 英小文字で始まり、英小文字・数字・アンダースコアのみ
- ユニーク制約（重複チェック）
- プレースホルダー：「my_name」
- 説明テキスト：「英小文字で始まり、英小文字・数字・アンダースコアのみ、3〜20文字」
- **技術的注意**：slug 変更時は公開プロフィールページのキャッシュもリフレッシュする
  - `revalidatePath("/mypage")`
  - `revalidatePath("/p/[profile_id]", "page")`

---

## 4. バリデーションとエラー処理

**重要原則：すべてのバリデーションはサーバー側（Server Actions）で実行する。** クライアント側のバリデーションは UX 向上のための補助的な機能として追加可能だが、**セキュリティと整合性の担保はサーバー側で行う。**

### 処理の分離

**Server Actions（必須）**：
- 入力値のバリデーション（文字数、形式、必須チェック）
- x_username の正規化処理（@削除、URL からの抽出）
- slug のユニーク制約チェック
- データベース更新
- キャッシュのリフレッシュ

**Client Components（補助的）**：
- フォームの表示切り替え（表示モード ⇔ 編集モード）
- エラーメッセージの表示
- 文字カウンターのリアルタイム表示
- ローディング状態の表示

### エラーメッセージ

各入力フォームの直下に赤文字で表示する。

- **表示名**：
  - 空欄の場合：「表示名を入力してください」
  - 50文字を超える場合：「表示名は50文字以内で入力してください」
- **自己紹介**：
  - 160文字を超える場合：「自己紹介は160文字以内で入力してください」
- **X アカウント**：
  - 正規化に失敗した場合：「有効なXアカウントを入力してください」
- **カスタムURL**：
  - 形式不正の場合：「英小文字で始まり、英小文字・数字・アンダースコアのみ、3〜20文字で入力してください」
  - 重複している場合：「このURLは既に使用されています」

### エラー表示の挙動
1. 保存ボタンをクリック
2. **Server Action でバリデーション実行**
3. エラーがある場合、`ActionResult` でエラー情報を返す
4. Client Component が該当フォームの直下に赤文字でメッセージ表示

---

## 5. 保存/キャンセル操作

### 5.1 ボタン配置
編集モードのフォーム最下部に2つのボタンを配置：
- **「保存する」ボタン**：青色、目立つデザイン
- **「キャンセル」ボタン**：グレー、控えめなデザイン

### 5.2 一括保存の Server Action

**新しい `updateProfile` Server Action を作成する。** 全項目をまとめて1回のDBアクセスで更新し、部分的に保存される問題を防ぐ。

```
ActionResult を返す updateProfile Server Action:
  - FormData から全項目を取得
  - サーバー側でバリデーション（display_name, bio, x_username, slug）
  - x_username の正規化処理
  - 1回の Supabase update で全項目を更新
  - slug 変更時は公開プロフィールページのキャッシュもリフレッシュ
  - エラーは項目ごとにまとめて返す
```

既存の個別 Server Actions（`updateDisplayName`, `updateBio`, `updateSlug`）はオンボーディング等で引き続き使用する。

### 5.3 保存時の挙動
1. ユーザーが「保存する」ボタンをクリック
2. **Server Action でバリデーション + データベース更新を実行**
3. 成功時：
   - 編集モードから表示モードに切り替え
   - トースト通知を2秒間表示：「保存しました」（緑色）
   - 更新された情報が表示モードに反映される
   - Dirty state をクリア
4. エラー時：
   - 編集モードのまま
   - 該当フォームの直下にエラーメッセージ表示

### 5.4 キャンセル時の挙動（未保存の変更保護）
1. ユーザーが「キャンセル」ボタンをクリック
2. **フォームの変更を検知（dirty state tracking）**
3. 変更がある場合：
   - **ブラウザ標準の確認ダイアログ**を表示：`window.confirm('保存していない変更があります。破棄しますか？')`
   - 「OK」を選択 → 編集内容を破棄して表示モードに戻る
   - 「キャンセル」を選択 → 編集モードのまま
4. 変更がない場合：
   - 確認なしで表示モードに戻る

### 5.5 ブラウザの戻るボタン・ページ遷移時の保護
編集モード中に未保存の変更がある状態でブラウザの戻るボタン、リンククリック、ページリロードをした場合：
- **ブラウザ標準の確認ダイアログ**を自動表示
- 実装：`beforeunload` イベントをリッスン、dirty state がある場合のみ発火

**メリット**：
- モバイル Safari/Chrome のネイティブUIを活用
- カスタムモーダルコンポーネント不要
- ユーザーにとって馴染みのあるUX

---

## 6. 将来の拡張

### 6.1 アバター画像のアップロード機能
ユーザーのオリジナル画像に変更可能にする。

- 画像ファイル選択UI（編集モード内）
- Supabase Storage へのアップロード
- 画像の最適化・リサイズ
- `avatar_url` の更新

現在は「※アバター変更は今後対応予定」とグレーテキストで案内する。

### 6.2 プロフィールタグ機能
ハッシュタグに似た、ユーザーの個性を視覚的に表すタグを実装予定。
設計書: `docs/plans/2026-02-13-profile-tags-design.md`
