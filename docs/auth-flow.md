# 認証フロー

新規ユーザー登録からログイン、マイページまでの認証フローの全体像を図示します。

## 認証フロー全体図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         【認証フロー全体図】                                  │
└─────────────────────────────────────────────────────────────────────────────┘

 ユーザー                   アプリ                    Supabase/OAuth
    │                         │                            │
    │  /login にアクセス       │                            │
    │────────────────────────>│                            │
    │                         │                            │
    │                   ┌─────┴─────┐                      │
    │                   │認証済み？  │                      │
    │                   └─────┬─────┘                      │
    │                    Yes/ \No                          │
    │                      /   \                           │
    │        ┌────────────┘     └────────────┐             │
    │        ▼                               ▼             │
    │   /my へリダイレクト          ログイン画面表示         │
    │        │                    [Google] [X(準備中)]     │
    │        │                               │             │
    │        │                               │             │
    │        │     「Google でログイン」クリック            │
    │<───────│───────────────────────────────│             │
    │        │                               │             │
    │        │                               │ OAuth開始    │
    │        │                               │────────────>│
    │        │                               │             │
    │        │                    ┌──────────│─────────────┤
    │        │                    │  Google 認証画面       │
    │        │                    │  (アカウント選択)       │
    │<───────│────────────────────┘                        │
    │        │                               │             │
    │  認証許可                               │             │
    │────────│───────────────────────────────│────────────>│
    │        │                               │             │
    │        │                    code付きで │             │
    │        │      /auth/callback にリダイレクト          │
    │        │<──────────────────────────────│─────────────│
    │        │                               │             │
```

## /auth/callback 処理詳細

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    【/auth/callback 処理詳細】                               │
└─────────────────────────────────────────────────────────────────────────────┘

                         /auth/callback (route.ts)
                                   │
                                   ▼
                    ┌──────────────────────────┐
                    │  code パラメータあり？    │
                    └────────────┬─────────────┘
                           Yes / \ No
                             /   \
                            /     \
                           ▼       ▼
                    code→session   /login?error=auth へ
                         交換              リダイレクト
                           │
                           ▼
                    ┌──────────────────────────┐
                    │   user 情報取得           │
                    │   (supabase.auth.getUser) │
                    └────────────┬─────────────┘
                                 │
                                 ▼
                    ┌──────────────────────────┐
                    │  profiles テーブルに      │
                    │  owner_user_id で検索     │
                    └────────────┬─────────────┘
                           Yes / \ No
                      (既存)  /   \  (新規)
                            /     \
                           ▼       ▼
               ┌──────────────┐  ┌────────────────────────────┐
               │ 既存の        │  │ 【新規プロフィール自動作成】  │
               │ profile_id   │  │                            │
               │ を取得       │  │ ・profile_id 生成 (15桁base62)│
               └──────┬───────┘  │ ・display_name (OAuth名前)   │
                      │          │ ・avatar_url (OAuthアバター)  │
                      │          │ ・x_username                 │
                      │          │   - X OAuth → user_name     │
                      │          │   - Google → null           │
                      │          │                            │
                      │          │ profiles テーブルに INSERT   │
                      │          └─────────────┬──────────────┘
                      │                        │
                      └────────┬───────────────┘
                               │
                               ▼
                    ┌──────────────────────────┐
                    │  /p/{profile_id} へ      │
                    │     リダイレクト          │
                    │  (自分のプロフィール表示)  │
                    └──────────────────────────┘
```

## /my ページの動作

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       【/my ページの動作】                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                           /my にアクセス
                                 │
                                 ▼
                    ┌──────────────────────────┐
                    │   認証チェック            │
                    │  (supabase.auth.getUser) │
                    └────────────┬─────────────┘
                          認証済み?
                           Yes / \ No
                             /   \
                            ▼     ▼
            ┌────────────────┐   /login へリダイレクト
            │ profiles から   │
            │ 自分のプロフィール│
            │ を検索          │
            └───────┬────────┘
              found? │
              Yes / \ No
                /   \
               ▼     ▼
     /p/{profile_id}  /login へリダイレクト
        へリダイレクト   (エッジケース)
```

## まとめ: 主要パス

### 新規ユーザー

```
/login → Google認証 → /auth/callback → プロフィール自動作成 → /p/{id}
                                              ↑
                                    display_name, avatar_url を
                                    OAuth情報から自動設定
```

### 既存ユーザー (再ログイン)

```
/login → Google認証 → /auth/callback → 既存profile_id取得 → /p/{id}
```

### ログイン済みユーザー

```
/login → (認証済み検出) → /my → /p/{id}
/my    → (認証済み検出) → /p/{id}
```

## URL・ファイルの役割

| URL | 役割 | 実装ファイル |
|-----|------|-------------|
| `/login` | ログイン画面。認証済みなら `/my` へリダイレクト | `src/app/login/page.tsx` |
| `/auth/callback` | OAuth コールバック。code→session交換＆新規ユーザーならプロフィール自動作成 | `src/app/auth/callback/route.ts` |
| `/my` | マイページ（ショートカット）。自分のプロフィールページへリダイレクト | `src/app/my/page.tsx` |
| `/p/{profile_id}` | プロフィール表示ページ（公開） | `src/app/p/[profile_id]/page.tsx` |

* GoogleやXのアカウントのアバター画像は基本**公開URLのため**ストレージに保存する必要はほぼ無い。（パフォーマンスが落ちるほど人数が増えるか、速度を上げたい時に有効かも？）

## OAuth プロバイダー別のメタデータマッピング

### Google OAuth

- `display_name` ← `user_metadata.name` または `user_metadata.full_name`
- `avatar_url` ← `user_metadata.picture`
- `x_username` ← `null` (未設定)

### X (Twitter) OAuth (準備中)

- `display_name` ← `user_metadata.name` または `user_metadata.full_name`
- `avatar_url` ← `user_metadata.avatar_url`
- `x_username` ← `user_metadata.user_name`

## 認証状態の確認方法

```typescript
// Server Component
const supabase = await createClient();
const { data: { user } } = await supabase.auth.getUser();

// Client Component
const supabase = createBrowserClient(...);
const { data: { user } } = await supabase.auth.getUser();
```

## プロフィールID生成

- 形式: 15文字の base62 ランダムID
- 生成関数: `generateProfileId()` (`src/lib/id.ts`)
- 特徴: 暗号学的に安全、URL セーフ、推測不可能
